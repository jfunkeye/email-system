<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Email - AuthSystem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div class="min-vh-100 d-flex align-items-center justify-content-center p-3">
        <div class="glass-card p-4 p-md-5 w-100 text-center" style="max-width: 500px;">
            <div class="mb-5">
                <a href="index.html" class="text-white text-decoration-none">
                    <h2 class="fw-bold">
                        <i class="fas fa-shield-alt me-2"></i>AuthSystem
                    </h2>
                </a>
                <p class="text-white opacity-75 mt-2">Email Verification</p>
            </div>

            <div id="notification"></div>

            <!-- Loading State -->
            <div id="loadingState">
                <div class="spinner-border text-white mb-4" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="text-white mb-3">Verifying your email...</h4>
                <p class="text-white opacity-75">Please wait while we verify your email address.</p>
            </div>

            <!-- Success State -->
            <div id="successState" class="d-none">
                <div class="success-icon mb-4">
                    <div class="rounded-circle bg-success d-inline-flex align-items-center justify-content-center" 
                         style="width: 80px; height: 80px;">
                        <i class="fas fa-check fa-2x text-white"></i>
                    </div>
                </div>
                <h4 class="text-white mb-3">Email Verified Successfully!</h4>
                <p class="text-white opacity-75 mb-4">
                    Your email address has been successfully verified. You can now access all features of your account.
                </p>
                <div class="d-grid gap-2">
                    <a href="login.html" class="btn btn-gradient py-3">
                        <i class="fas fa-sign-in-alt me-2"></i>Sign In to Your Account
                    </a>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="d-none">
                <div class="error-icon mb-4">
                    <div class="rounded-circle bg-danger d-inline-flex align-items-center justify-content-center" 
                         style="width: 80px; height: 80px;">
                        <i class="fas fa-times fa-2x text-white"></i>
                    </div>
                </div>
                <h4 class="text-white mb-3">Verification Failed</h4>
                <p class="text-white opacity-75 mb-4" id="errorMessage">
                    We couldn't verify your email address. The verification link may be invalid or expired.
                </p>
                <div class="row g-3">
                    <div class="col-md-6">
                        <a href="signup.html" class="btn btn-outline-light w-100 py-3">
                            <i class="fas fa-user-plus me-2"></i>Create New Account
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="login.html" class="btn btn-gradient w-100 py-3">
                            <i class="fas fa-sign-in-alt me-2"></i>Try Signing In
                        </a>
                    </div>
                </div>
            </div>

            <!-- Resend Verification -->
            <div id="resendSection" class="mt-5 p-4 bg-white/10 rounded-lg d-none">
                <h5 class="text-white mb-3">Need a new verification email?</h5>
                <p class="text-white opacity-75 small mb-3">
                    If you didn't receive the verification email or it expired, you can request a new one.
                </p>
                <form id="resendVerificationForm">
                    <div class="mb-3">
                        <label for="resendEmail" class="form-label text-white small">Email Address</label>
                        <input type="email" class="form-control" id="resendEmail" name="email" required 
                               placeholder="Enter your email address">
                    </div>
                    <button type="submit" class="btn btn-outline-light w-100">
                        <i class="fas fa-paper-plane me-2"></i>Resend Verification Email
                    </button>
                </form>
            </div>

            <!-- Support Information -->
            <div class="mt-5 p-3 bg-white/10 rounded-lg">
                <h6 class="text-white mb-2"><i class="fas fa-life-ring me-2 text-info"></i>Need Help?</h6>
                <p class="text-white opacity-75 small mb-2">
                    If you're experiencing issues with email verification, please contact our support team.
                </p>
                <div class="d-flex justify-content-center gap-3">
                    <a href="mailto:support@authsystem.com" class="text-white text-decoration-none small">
                        <i class="fas fa-envelope me-1"></i>Email Support
                    </a>
                    <a href="#" class="text-white text-decoration-none small">
                        <i class="fas fa-question-circle me-1"></i>Help Center
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loadingState = document.getElementById('loadingState');
            const successState = document.getElementById('successState');
            const errorState = document.getElementById('errorState');
            const resendSection = document.getElementById('resendSection');
            const errorMessage = document.getElementById('errorMessage');
            const notification = document.getElementById('notification');

            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            async function verifyEmail() {
                if (!token) {
                    showError('No verification token provided. Please check your email for the complete verification link.');
                    return;
                }

                try {
                    const result = await API.auth.verifyEmail(token);
                    
                    if (result.success) {
                        // Show success state
                        loadingState.classList.add('d-none');
                        successState.classList.remove('d-none');
                        
                        // Show success notification
                        Utils.showNotification('Email verified successfully!', 'success');
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    showError(error.message || 'Email verification failed. The link may be invalid or expired.');
                }
            }

            function showError(message) {
                loadingState.classList.add('d-none');
                errorState.classList.remove('d-none');
                resendSection.classList.remove('d-none');
                errorMessage.textContent = message;
            }

            // Resend verification form
            document.getElementById('resendVerificationForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const email = formData.get('email');
                const button = this.querySelector('button[type="submit"]');
                
                if (!Utils.validateEmail(email)) {
                    Utils.showNotification('Please enter a valid email address', 'danger');
                    return;
                }

                // Show loading state on button
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
                button.disabled = true;

                try {
                    // Note: You'll need to implement a resend verification endpoint in your backend
                    // For now, we'll simulate the API call
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    Utils.showNotification('If the email exists, a new verification link has been sent.', 'success');
                    this.reset();
                } catch (error) {
                    Utils.showNotification('Failed to send verification email', 'danger');
                } finally {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            });

            // Start verification process
            verifyEmail();
        });
    </script>

    <style>
        .success-icon, .error-icon {
            animation: scaleIn 0.5s ease-out;
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .spinner-border {
            animation: spin 1s linear infinite;
        }
    </style>
</body>
</html>